// vim: set autoindent shiftwidth=4 tabstop=8:
/**
 * @class IWL.PageControl is a class for adding paging functionality to widgets
 * @extends IWL.Widget
 * */
IWL.PageControl = Object.extend(Object.extend({}, IWL.Widget), (function () {
    function initEvents() {
        this.firstButton.signalConnect('click', function() {
            if (!this.element) return;
            this.emitSignal('iwl:current_page_is_changing', {type: 'first'});
            this.element.emitEvent(this.eventName, {
                page: this.currentPage, type: 'first',
                pageSize: this.options.pageSize, pageCount: this.options.pageCount
            }, {responseCallback: onEventComplete.bind(this)});
        }.bind(this));
        this.prevButton.signalConnect('click', function() {
            if (!this.element) return;
            this.emitSignal('iwl:current_page_is_changing', {type: 'prev'});
            this.element.emitEvent(this.eventName, {
                page: this.currentPage, type: 'prev',
                pageSize: this.options.pageSize, pageCount: this.options.pageCount
            }, {responseCallback: onEventComplete.bind(this)});
        }.bind(this));
        this.nextButton.signalConnect('click', function() {
            if (!this.element) return;
            this.emitSignal('iwl:current_page_is_changing', {type: 'next'});
            this.element.emitEvent(this.eventName, {
                page: this.currentPage, type: 'next',
                pageSize: this.options.pageSize, pageCount: this.options.pageCount
            }, {responseCallback: onEventComplete.bind(this)});
        }.bind(this));
        this.lastButton.signalConnect('click', function() {
            if (!this.element) return;
            this.emitSignal('iwl:current_page_is_changing', {type: 'last'});
            this.element.emitEvent(this.eventName, {
                page: this.currentPage, type: 'last',
                pageSize: this.options.pageSize, pageCount: this.options.pageCount
            }, {responseCallback: onEventComplete.bind(this)});
        }.bind(this));
        this.input.signalConnect('keydown', function(event) {
            if (!this.element) return;
            if (event.keyCode == Event.KEY_RETURN && this.input.value != this.currentPage) {
                if (!this.input.checkValue({reg:/^\d*$/})) return;
                this.emitSignal('iwl:current_page_is_changing', {type: 'input', value: this.input.value});
                this.element.emitEvent(this.eventName, {
                    page: this.currentPage, type: 'input',
                    value: this.input.value, pageSize: this.options.pageSize, pageCount: this.options.pageCount
                }, {responseCallback: onEventComplete.bind(this)});
            }
        }.bind(this));
    }

    function onEventComplete(json, params, options) {
        if (options.update) {
            var page = {
                input: params.value,
                first: 1,
                prev: params.page - 1 || 1,
                next: params.page + 1 > params.pageCount ? params.pageCount : params.page + 1,
                last: params.pageCount
            };
            var page_options = {page: page[params.type]};
        } else {
            var page_options = json.extras;
        }
        if (page_options) {
            if (page_options.page)
                this.currentPage = page_options.page;
            if (page_options.pageSize)
                this.setPageSize(page_options.pageSize);

            if (page_options.pageCount) {
                this.setPageCount(page_options.pageCount);
            } else {
                refresh.call(this);
            }
        } else {
            refresh.call(this);
        }
        this.emitSignal('iwl:current_page_change');
    }

    function refresh() {
        if (!this.loaded) return;
        if (!this.options.bound || this.options.pageCount <= 1) {
            var hidden = {visibility: 'hidden'};
            this.setStyle(hidden);
            this.firstButton.setStyle(hidden);
            this.prevButton.setStyle(hidden);
            this.nextButton.setStyle(hidden);
            this.lastButton.setStyle(hidden);
        } else {
            var dims = this.getDimensions();
            this.setStyle({width: dims.width + 'px', height: dims.height + 'px', visibility: 'visible'});
            toggleButtons.call(this);
            this.input.value = this.currentPage;
        }
    }

    function toggleButtons() {
        var visible = {visibility: 'visible'};
        var hidden = {visibility: 'hidden'};
        if (this.currentPage == 1) {
            this.firstButton.setStyle(hidden);
            this.prevButton.setStyle(hidden);
        } else {
            this.firstButton.setStyle(visible);
            this.prevButton.setStyle(visible);
        }
        if (this.currentPage == this.options.pageCount) {
            this.nextButton.setStyle(hidden);
            this.lastButton.setStyle(hidden);
        } else {
            this.nextButton.setStyle(visible);
            this.lastButton.setStyle(visible);
        }
    }

    return {
        /**
         * Binds an element to the page control widget
         * @param element The element to bind to
         * @param event_name The event name associated with the page. Example: 'IWL-Tree-refresh'
         * @returns The object
         * */
        bindToWidget: function(element, event_name) {
            if (this.element) return;
            this.element = $(element);
            this.eventName = event_name;
            refresh.call(this);
            return this;
        },
        /**
         * Sets the page count for the page control widget
         * @param {int} count The number of pages
         * @returns The object
         * */
        setPageCount: function(count) {
            if (this.options.pageCount != count)
                this.label.update(count);
            this.options.pageCount = count;
            refresh.call(this);
            return this;
        },
        /**
         * Sets the page size for the page control widget
         * @param {int} size The number of elements for each page
         * @returns The object
         * */
        setPageSize: function(size) {
            this.options.pageSize = size;
            return this;
        },
        /**
         * @ignore
         * */
        getDimensions: function() {
            var dims = {width: 0, height: 0};
            [this.firstButton, this.prevButton, this.labelContainer, this.nextButton, this.lastButton].each(
                function(n) {
                    var d = n.getDimensions();
                    var m = [n.getStyle('margin-top'), n.getStyle('margin-right'), n.getStyle('margin-bottom'), n.getStyle('margin-left')];
                    dims.width += d.width + parseInt(m[1] || 0) + parseInt(m[3] || 0);

                    dims.height = Math.max(d.height + parseInt(m[0] || 0) + parseInt(m[2] || 0), dims.height);
                }.bind(this)
            );
            // FIXME: why does IE need this additional width?
            if (Prototype.Browser.IE)
                dims.width += 3;
            return dims;
        },

        _init: function(id) {
            var buttonCount = 4;
            this.loaded = false;
            var buttonLoad = function() {
                if (--buttonCount === 0) {
                    this.loaded = true;
                    refresh.call(this);
                    this.emitSignal('iwl:load');
                }
            };
            this.firstButton = $(this.id + '_first').signalConnect('iwl:load', buttonLoad.bind(this));
            this.prevButton = $(this.id + '_prev').signalConnect('iwl:load', buttonLoad.bind(this));
            this.labelContainer = $(this.id + '_label');
            this.input = $(this.id + '_page_entry_text');
            this.label = $(this.id + '_page_count');
            this.nextButton = $(this.id + '_next').signalConnect('iwl:load', buttonLoad.bind(this));
            this.lastButton = $(this.id + '_last').signalConnect('iwl:load', buttonLoad.bind(this));
            this.options = Object.extend({
                bound: false,
                page: 1
            }, arguments[1] || {});
            this.input.value = this.currentPage = this.options.page;
            this.show();

            initEvents.call(this);
        }
    }
})());

/* Deprecated */
var PageControl = IWL.PageControl;
